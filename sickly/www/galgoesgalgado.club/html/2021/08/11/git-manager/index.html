<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>git_manager</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/heti.min.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
</head><body><div class="header"><a class="github-link" target="_blank" rel="noopener" href="https://notabug.org/micaldas"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="email-link" href="mailto:mclds@protonmail.com"><img class="email-image" src="/images/email-small.png"></a><a class="subscribe-link" href="/atom.xml"><img class="subscribe-image" src="/images/subscribe-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">git_manager</p></h2><div class="post-date"><time datetime="2021-08-11T18:51:07.000Z">2021-08-11</time></div><div class="post-content"><p>I’ve been thinking for some time in ways to automate the git uploading process.<br>I have eighteen repositories now and it’s getting harder to track down their state.<br>I wanted something that would automate the repetitive parts, (init, the commit then push…) and that was aware of their update needs.<br>So, I thought of this:  </p>
<ol>
<li><p>First create a dictionary with names and urls of all the repositories and keep it in a file:  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;Dictionary with lists of my git projects&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repo_list</span>():</span></span><br><span class="line">    repo_list.<span class="built_in">dict</span> = &#123;</span><br><span class="line">        <span class="string">&quot;bkmks&quot;</span>: <span class="string">&quot;/home/mic/python/bkmk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;urwid&quot;</span>: <span class="string">&quot;/home/mic/python/bkmks_urwid&quot;</span>,</span><br><span class="line">        <span class="string">&quot;books&quot;</span>: <span class="string">&quot;/home/mic/python/books&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cli_app&quot;</span>: <span class="string">&quot;/home/mic/python/cli_app_list&quot;</span>,</span><br><span class="line">        <span class="string">&quot;micro_diary&quot;</span>: <span class="string">&quot;/home/mic/python/micro_diary&quot;</span>,</span><br><span class="line">        <span class="string">&quot;notes&quot;</span>: <span class="string">&quot;/home/mic/python/notes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;old_projects&quot;</span>: <span class="string">&quot;/home/mic/python/old_alternative_projects&quot;</span>,</span><br><span class="line">        <span class="string">&quot;player&quot;</span>: <span class="string">&quot;/home/mic/python/player&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pwd&quot;</span>: <span class="string">&quot;/home/mic/python/pwd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;rss&quot;</span>: <span class="string">&quot;/home/mic/python/rss&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scraper&quot;</span>: <span class="string">&quot;/home/mic/python/scraper&quot;</span>,</span><br><span class="line">        <span class="string">&quot;todos&quot;</span>: <span class="string">&quot;/home/mic/python/todos&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tree&quot;</span>: <span class="string">&quot;/home/mic/python/tree&quot;</span>,</span><br><span class="line">        <span class="string">&quot;urlshort&quot;</span>: <span class="string">&quot;/home/mic/python/urlshort&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scripts&quot;</span>: <span class="string">&quot;/home/mic/scripts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;python_blog&quot;</span>: <span class="string">&quot;/home/mic/hexo-python-blog&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hexo-poems&quot;</span>: <span class="string">&quot;/home/mic/hexo-poems&quot;</span>,</span><br><span class="line">        <span class="string">&quot;site&quot;</span>: <span class="string">&quot;/srv/http&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> repo_list.<span class="built_in">dict</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    repo_list()</span><br></pre></td></tr></table></figure></li>
<li><p>Now we will test all repositories to know if they need updating, by going in their directories and typing the command “git status”. We convert the function object in a dictionary so as to be simple to handle.<br>We iterate through a loop for all the values of the dictionary, go to their location and do ‘git status’. We collect the output to a file. I used a bash expression so as to be able to use the git command “git status”. The ‘$()’ is the format for commands in bash.  I used the expression ‘&amp;&gt;’ instead of only ‘&gt;’, to write to a file because the ampersand diverts standard error as the ‘&gt;’ diverts output. ‘cwd’ means ‘current working directory’ and determines where the subprocess command will take place.  </p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repositories</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Here we harvest a &#x27;git status&#x27; of all the repositories&quot;&quot;&quot;</span></span><br><span class="line">    repositories.repos = repo_list()</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> repositories.repos.values():</span><br><span class="line">        cmd = <span class="string">&quot;echo $(git status) &amp;&gt; status_results.txt&quot;</span></span><br><span class="line">        subprocess.run(cmd, cwd=value, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    repositories()</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Again we iterate through the list of values of our dictionary to find the files with the answers to our former query. We open them and if the strings “Changes no staged for commit” and “Untracked files” are present, we put them in a list of repositories to update.  </li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Here we verify who needs an update&quot;&quot;&quot;</span></span><br><span class="line">    update.lst = []</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> repositories.repos.values():</span><br><span class="line">        path = value + <span class="string">&quot;/status_results.txt&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            status_content = f.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Changes not staged for commit&quot;</span> <span class="keyword">or</span> <span class="string">&quot;Untracked files&quot;</span> <span class="keyword">in</span> status_content:</span><br><span class="line">            update.lst.append(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    update()</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>And, at last, we iterate through a list of dictionary items, (key:value), and if we find the path in the list of repositories to update, we take it’s name and put it in a list.<br>To update the repositories it was needed to create specific scripts for each repo, and this is because I used <a target="_blank" rel="noopener" href="https://linux.die.net/man/1/autoexpect">Autoexpect</a> to create them. Autoexpect ‘films’ us doing a given set of commands and operations and repeats them when called out to. It’s particularly useful when having scripts that need authentication.<br>Here’s and example of one of the scripts:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/expect -f</span><br><span class="line">#</span><br><span class="line"># This Expect script was generated by autoexpect on Wed Aug 11 18:18:48 2021</span><br><span class="line"># Expect and autoexpect were both written by Don Libes, NIST.</span><br><span class="line">#</span><br><span class="line"># Note that autoexpect does not guarantee a working script.  It</span><br><span class="line"># necessarily has to guess about certain things.  Two reasons a script</span><br><span class="line"># might fail are:</span><br><span class="line">#</span><br><span class="line"># 1) timing - A surprising number of programs (rn, ksh, zsh, telnet,</span><br><span class="line"># etc.) and devices discard or ignore keystrokes that arrive &quot;too</span><br><span class="line"># quickly&quot; after prompts.  If you find your new script hanging up at</span><br><span class="line"># one spot, try adding a short sleep just before the previous send.</span><br><span class="line"># Setting &quot;force_conservative&quot; to 1 (see below) makes Expect do this</span><br><span class="line"># automatically - pausing briefly before sending each character.  This</span><br><span class="line"># pacifies every program I know of.  The -c flag makes the script do</span><br><span class="line"># this in the first place.  The -C flag allows you to define a</span><br><span class="line"># character to toggle this mode off and on.</span><br><span class="line"></span><br><span class="line">set force_conservative 0  ;# set to 1 to force conservative mode even if</span><br><span class="line">			 ;# script wasn&#x27;t run conservatively originally</span><br><span class="line">if &#123;$force_conservative&#125; &#123;</span><br><span class="line">	set send_slow &#123;1 .1&#125;</span><br><span class="line">	proc send &#123;ignore arg&#125; &#123;</span><br><span class="line">		sleep .1</span><br><span class="line">		exp_send -s -- $arg</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># 2) differing output - Some programs produce different output each time</span><br><span class="line"># they run.  The &quot;date&quot; command is an obvious example.  Another is</span><br><span class="line"># ftp, if it produces throughput statistics at the end of a file</span><br><span class="line"># transfer.  If this causes a problem, delete these patterns or replace</span><br><span class="line"># them with wildcards.  An alternative is to use the -p flag (for</span><br><span class="line"># &quot;prompt&quot;) which makes Expect only look for the last line of output</span><br><span class="line"># (i.e., the prompt).  The -P flag allows you to define a character to</span><br><span class="line"># toggle this mode off and on.</span><br><span class="line">#</span><br><span class="line"># Read the man page for more info.</span><br><span class="line">#</span><br><span class="line"># -Don</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set timeout -1</span><br><span class="line">spawn $env(SHELL)</span><br><span class="line">match_max 100000</span><br><span class="line">expect -exact &quot;[1m[7m#[27m[1m[0m                              \r \r\r[0m[27m[24m[Jmicaldas# [K[?2004h&quot;</span><br><span class="line">send -- &quot;gi&quot;</span><br><span class="line">expect -exact gi&quot;</span><br><span class="line">send -- &quot;t add .\r&quot;</span><br><span class="line">expect -exact &quot;[?2004l\r\r</span><br><span class="line">[1m[7m#[27m[1m[0m               \r \r\r[0m[27m[24m[Jmicaldas# [K[?2004h&quot;</span><br><span class="line">send -- &quot;gi&quot;</span><br><span class="line">expect -exact gi&quot;</span><br><span class="line">send -- &quot;t commit -m \&quot;Nth commit\&quot;\r&quot;</span><br><span class="line">expect -exact &quot;[?2004l\r\r</span><br><span class="line">\[master e2c3369\] Nth commit\r</span><br><span class="line"> 2 files changed, 1 insertion(+)\r</span><br><span class="line"> create mode 100755 script.exp\r</span><br><span class="line"> create mode 100644 status_results.txt\r</span><br><span class="line">[1m[7m#[27m[1m[0m               \r \r\r[0m[27m[24m[Jmicaldas# [K[?2004h&quot;</span><br><span class="line">send -- &quot;gi&quot;</span><br><span class="line">expect -exact gi&quot;</span><br><span class="line">send -- &quot;t push origin master\r&quot;</span><br><span class="line">expect -exact &quot;[?2004l\r\r</span><br><span class="line">fatal: &#x27;origin&#x27; does not appear to be a git repository\r</span><br><span class="line">fatal: Could not read from remote repository.\r</span><br><span class="line">\r</span><br><span class="line">Please make sure you have the correct access rights\r</span><br><span class="line">and the repository exists.\r</span><br><span class="line">[1m[7m#[27m[1m[0m               \r \r\r[0m[27m[24m[Jmicaldas# [K[?2004h&quot;</span><br><span class="line">send -- &quot;[A&quot;</span><br><span class="line">expect -exact &quot;git push origin master&quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;[D&quot;</span><br><span class="line">expect -exact &quot;</span><br><span class="line">send -- &quot;_&quot;</span><br><span class="line">expect -exact &quot;_&quot;master</span><br><span class="line">send -- &quot;g&quot;</span><br><span class="line">expect -exact &quot;g&quot;master</span><br><span class="line">send -- &quot;o&quot;</span><br><span class="line">expect -exact &quot;o&quot;master</span><br><span class="line">send -- &quot;g&quot;</span><br><span class="line">expect -exact &quot;g&quot;master</span><br><span class="line">send -- &quot;s&quot;</span><br><span class="line">expect -exact &quot;s&quot;master</span><br><span class="line">send -- &quot;\r&quot;</span><br><span class="line">expect -exact &quot;[?2004l\r\r</span><br><span class="line">Enumerating objects: 5, done.\r</span><br><span class="line">Counting objects:  20% (1/5)\rCounting objects:  40% (2/5)\rCounting objects:  60% (3/5)\rCounting objects:  80% (4/5)\rCounting objects: 100% (5/5)\rCounting objects: 100% (5/5), done.\r</span><br><span class="line">Delta compression using up to 8 threads\r</span><br><span class="line">Compressing objects:  33% (1/3)\rCompressing objects:  66% (2/3)\rCompressing objects: 100% (3/3)\rCompressing objects: 100% (3/3), done.\r</span><br><span class="line">Writing objects:  25% (1/4)\rWriting objects:  50% (2/4)\rWriting objects:  75% (3/4)\rWriting objects: 100% (4/4)\rWriting objects: 100% (4/4), 486 bytes | 486.00 KiB/s, done.\r</span><br><span class="line">Total 4 (delta 0), reused 0 (delta 0), pack-reused 0\r</span><br><span class="line">Username for &#x27;http://localhost:3000&#x27;: &quot;</span><br><span class="line">send -- &quot;mic\r&quot;</span><br><span class="line">expect -exact &quot;mic\r</span><br><span class="line">Password for &#x27;http://mic@localhost:3000&#x27;: &quot;</span><br><span class="line">send -- &quot;xxxx\r&quot;</span><br><span class="line">expect -exact &quot;\r</span><br><span class="line">To http://localhost:3000/mic/tree.git\r</span><br><span class="line">   5bd1295..e2c3369  master -&gt; master\r</span><br><span class="line">[1m[7m#[27m[1m[0m               \r \r\r[0m[27m[24m[Jmicaldas# [K[?2004h&quot;</span><br><span class="line">send -- &quot;&quot;</span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Getting back to the python document. For each name that we find in our list of paths to repos that needed updating, write the url to the bash script that’ll do the job, and run it with subprocess.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">final_update</span>():</span></span><br><span class="line">    <span class="string">&quot;Here we proceed at the actual update&quot;</span></span><br><span class="line">    names = []</span><br><span class="line">    <span class="keyword">for</span> name, path <span class="keyword">in</span> repositories.repos.items():</span><br><span class="line">        <span class="keyword">if</span> path <span class="keyword">in</span> update.lst:</span><br><span class="line">            names.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">        cmd = <span class="string">&quot;/home/mic/scripts/git_manager/&quot;</span> + name + <span class="string">&quot;.exp&quot;</span></span><br><span class="line">        subprocess.run(cmd, shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>Here’s the final document:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;This function checks if the output says that is needed to update the repository&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> dic <span class="keyword">import</span> repo_list</span><br><span class="line"></span><br><span class="line">fmt = <span class="string">&quot;&#123;time&#125; - &#123;name&#125; - &#123;level&#125; - &#123;message&#125;&quot;</span></span><br><span class="line">logger.add(<span class="string">&quot;spam.log&quot;</span>, level=<span class="string">&quot;DEBUG&quot;</span>, <span class="built_in">format</span>=fmt)</span><br><span class="line">logger.add(<span class="string">&quot;error.log&quot;</span>, level=<span class="string">&quot;ERROR&quot;</span>, <span class="built_in">format</span>=fmt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repositories</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Here we harvest a &#x27;git status&#x27; of all the repositories&quot;&quot;&quot;</span></span><br><span class="line">    repositories.repos = repo_list()</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> repositories.repos.values():</span><br><span class="line">        cmd = <span class="string">&quot;echo $(git status) &amp;&gt; status_results.txt&quot;</span></span><br><span class="line">        subprocess.run(cmd, cwd=value, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    repositories()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Here we verify who needs an update&quot;&quot;&quot;</span></span><br><span class="line">    update.lst = []</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> repositories.repos.values():</span><br><span class="line">        path = value + <span class="string">&quot;/status_results.txt&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            status_content = f.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Changes not staged for commit&quot;</span> <span class="keyword">or</span> <span class="string">&quot;Untracked files&quot;</span> <span class="keyword">in</span> status_content:</span><br><span class="line">            update.lst.append(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    update()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">final_update</span>():</span></span><br><span class="line">    <span class="string">&quot;Here we proceed at the actual update&quot;</span></span><br><span class="line">    names = []</span><br><span class="line">    <span class="keyword">for</span> name, path <span class="keyword">in</span> repositories.repos.items():</span><br><span class="line">        <span class="keyword">if</span> path <span class="keyword">in</span> update.lst:</span><br><span class="line">            names.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">        cmd = <span class="string">&quot;/home/mic/scripts/git_manager/&quot;</span> + name + <span class="string">&quot;.exp&quot;</span></span><br><span class="line">        subprocess.run(cmd, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    final_update()</span><br></pre></td></tr></table></figure>

<hr>
<h2><span id="update">UPDATE</span></h2><p>Apparently I was hasty giving this module as terminated. I assumed that the Expect scripts would work as expected, and didn’t took the time to test them. Which is a particularly egregious mistake as they are numerous. A lot of work could have been spared if I just took the sensible precaution to see if the scripts were doing what they were supposed to do.<br>The problem, to add insult to injury, is very quickly diagnosed. Take the former Expect script example: when I do  a ‘git commit’, Expect ‘expects’ that the result of the commit is, <em>ipsis verbis</em>, equal to the one that was done when ‘recording’ the script:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">send -- &quot;t commit -m \&quot;Nth commit\&quot;\r&quot;</span><br><span class="line">expect -exact &quot;[?2004l\r\r</span><br><span class="line">\[master e2c3369\] Nth commit\r</span><br><span class="line"> 2 files changed, 1 insertion(+)\r</span><br></pre></td></tr></table></figure>

<p> Obviously when the script runs a second time, this does not happen and it stops, not knowing what to do.<br> There is a way around this, and it’s to use Expect as was originally intended, as a coding language, and write how you want it to react. Not just putting it ‘recording’ blindly your actions.<br> The problem with this is that the language is both ancient and hard. But I’m somewhat committed to making this work, so I won’t quit just now.<br> Asides from that, I made several changes to the code, that seemed excessively complex to me, to reach, I expected, a cleaner, simpler version.<br> But now, looking at it, it seems that my attempts to simplify made it hopelessly convoluted.<br> I seem to remember that these changes were done because the code was not working, asides from the Expect problem, and hence the necessity of this added complexity.<br> But, to be honest, I really don’t remember if my recollection is correct.<br> As I’m questioning this code, what I’ll do now is comment it and see if by retracing my steps this makes more sense. If not, I’ll change it as I write this.<br> The first thing I would like to get out of the way is the ‘logger’ statements. These are logging commands for <a target="_blank" rel="noopener" href="https://loguru.readthedocs.io/en/stable/overview.html">Loguru</a>. The ‘@logger.catch’ decorator collects all error messages produced by a specific function. The other logger statements are generally to let me visualize the state of a variable in a particular moment in time. It’s like ‘print’ but it doesn’t necessarily goes to standard output.  </p>
<ol>
<li>First thing I did was bring to the main file the repos list and turn it in a dictionary in global setting, so it can be used by all functions.  </li>
</ol>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">repo_dict = &#123;</span><br><span class="line">    <span class="string">&quot;bkmks&quot;</span>: <span class="string">&quot;/home/mic/python/bkmk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bkmks_urwid&quot;</span>: <span class="string">&quot;/home/mic/python/bkmks_urwid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;books&quot;</span>: <span class="string">&quot;/home/mic/python/books&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cli_app_list&quot;</span>: <span class="string">&quot;/home/mic/python/cli_app_list&quot;</span>,</span><br><span class="line">    <span class="string">&quot;micro_diary&quot;</span>: <span class="string">&quot;/home/mic/python/micro_diary&quot;</span>,</span><br><span class="line">    <span class="string">&quot;notes&quot;</span>: <span class="string">&quot;/home/mic/python/notes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;old_alternative_projects&quot;</span>: <span class="string">&quot;/home/mic/python/old_alternative_projects&quot;</span>,</span><br><span class="line">    <span class="string">&quot;player&quot;</span>: <span class="string">&quot;/home/mic/python/player&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pwd&quot;</span>: <span class="string">&quot;/home/mic/python/pwd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rss&quot;</span>: <span class="string">&quot;/home/mic/python/rss&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scraper&quot;</span>: <span class="string">&quot;/home/mic/python/scraper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scripts&quot;</span>: <span class="string">&quot;/home/mic/scripts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;todos&quot;</span>: <span class="string">&quot;/home/mic/python/todos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tree&quot;</span>: <span class="string">&quot;/home/mic/python/tree&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;/home/mic/python/urlshort&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-python-blog&quot;</span>: <span class="string">&quot;/home/mic/hexo-python-blog&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo_poems&quot;</span>: <span class="string">&quot;/home/mic/hexo-poems&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;/srv/http&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>The first function verifies what repos need an update.<br>We create a loop that runs through the paths to repos in said dictionary, and adds to them the name of the file that will be created when we run the ‘git status’ command through all repositories. This new list with the updated URLs, is called ‘paths’.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logger.info(repo_dict)</span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> repo_dict.values():</span><br><span class="line">    path.append(value + <span class="string">&quot;/status_results.txt&quot;</span>)</span><br><span class="line">logger.info(path)</span><br></pre></td></tr></table></figure></li>
<li>Now we look to the paths in the ‘path’ list, and check for the patterns that’ll tell us if its necessary to update the repo or not. These patterns are:</li>
</ol>
<ul>
<li>‘Changes not staged for commit’,</li>
<li>‘Untracked files’.<br>If we find these patterns in the file with the output of the ‘git status’ command, we append the URLs to a new list called ‘repositories.lst’.<br>From that list we take out only the repository names, with the <a target="_blank" rel="noopener" href="https://www.w3schools.com/python/ref_string_rsplit.asp">rsplit</a> method, that splits a string to a list. We define that we want only the penultimate value (-2), counted if we split the string by ‘/‘. This list will have only the repo names that need updating.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> path:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Changes not staged for commit&quot;</span> <span class="keyword">or</span> <span class="string">&quot;Untracked files&quot;</span> <span class="keyword">in</span> i:</span><br><span class="line">        repositories.lst.append(i)</span><br><span class="line">logger.info(repositories.lst)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> repositories.lst:</span><br><span class="line">    repositories.chaves.append(i.rsplit(<span class="string">&quot;/&quot;</span>)[-<span class="number">2</span>])</span><br><span class="line">logger.info(repositories.chaves)</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>As there is one Expect script per repository, we build a string URL that is composed of the path to these scripts, plus the repo names to update, that we take from repositories.chaves. As they are bash scripts, it’s necessary to use subprocess.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    <span class="string">&quot;Here we do the update&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> repositories.chaves:</span><br><span class="line">        cmd = <span class="string">&quot;/home/mic/scripts/git_manager/&quot;</span> + i + <span class="string">&quot;.exp&quot;</span></span><br><span class="line">        subprocess.run(cmd, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(cmd)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Of course that even with these changes the script still doesn’t work. It needs the Expect scripts working correctly.<br>But,<br>while writing this,<br>I corrected a lot of ‘corrections’ I did to the original version; that weren’t corrections at all, but added confusion, written when my brain was in a particularly foggy state.<br>Expect another update when I solve the Expect problem. I hope it’s soon.<br>Here is the updated file:  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fmt = <span class="string">&quot;&#123;time&#125; - &#123;name&#125; - &#123;level&#125; - &#123;message&#125;&quot;</span></span><br><span class="line">logger.add(<span class="string">&quot;logging/spam.log&quot;</span>, level=<span class="string">&quot;DEBUG&quot;</span>, <span class="built_in">format</span>=fmt, backtrace=<span class="literal">True</span>, diagnose=<span class="literal">True</span>)</span><br><span class="line">logger.add(<span class="string">&quot;logging/error.log&quot;</span>, level=<span class="string">&quot;ERROR&quot;</span>, <span class="built_in">format</span>=fmt, backtrace=<span class="literal">True</span>, diagnose=<span class="literal">True</span>)</span><br><span class="line">logger.add(<span class="string">&quot;logging/info.log&quot;</span>, level=<span class="string">&quot;INFO&quot;</span>, <span class="built_in">format</span>=fmt, backtrace=<span class="literal">True</span>, diagnose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">repo_dict = &#123;</span><br><span class="line">    <span class="string">&quot;bkmks&quot;</span>: <span class="string">&quot;/home/mic/python/bkmk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bkmks_urwid&quot;</span>: <span class="string">&quot;/home/mic/python/bkmks_urwid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;books&quot;</span>: <span class="string">&quot;/home/mic/python/books&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cli_app_list&quot;</span>: <span class="string">&quot;/home/mic/python/cli_app_list&quot;</span>,</span><br><span class="line">    <span class="string">&quot;micro_diary&quot;</span>: <span class="string">&quot;/home/mic/python/micro_diary&quot;</span>,</span><br><span class="line">    <span class="string">&quot;notes&quot;</span>: <span class="string">&quot;/home/mic/python/notes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;old_alternative_projects&quot;</span>: <span class="string">&quot;/home/mic/python/old_alternative_projects&quot;</span>,</span><br><span class="line">    <span class="string">&quot;player&quot;</span>: <span class="string">&quot;/home/mic/python/player&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pwd&quot;</span>: <span class="string">&quot;/home/mic/python/pwd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rss&quot;</span>: <span class="string">&quot;/home/mic/python/rss&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scraper&quot;</span>: <span class="string">&quot;/home/mic/python/scraper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scripts&quot;</span>: <span class="string">&quot;/home/mic/scripts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;todos&quot;</span>: <span class="string">&quot;/home/mic/python/todos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tree&quot;</span>: <span class="string">&quot;/home/mic/python/tree&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;/home/mic/python/urlshort&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo-python-blog&quot;</span>: <span class="string">&quot;/home/mic/hexo-python-blog&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hexo_poems&quot;</span>: <span class="string">&quot;/home/mic/hexo-poems&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;/srv/http&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repositories</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Verify what repos need an update&quot;&quot;&quot;</span></span><br><span class="line">    repositories.lst = []</span><br><span class="line">    path = []</span><br><span class="line">    repositories.chaves = []</span><br><span class="line"></span><br><span class="line">    logger.info(repo_dict)</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> repo_dict.values():</span><br><span class="line">        path.append(value + <span class="string">&quot;/status_results.txt&quot;</span>)</span><br><span class="line">    logger.info(path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Changes not staged for commit&quot;</span> <span class="keyword">or</span> <span class="string">&quot;Untracked files&quot;</span> <span class="keyword">in</span> i:</span><br><span class="line">            repositories.lst.append(i)</span><br><span class="line">    logger.info(repositories.lst)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> repositories.lst:</span><br><span class="line">        repositories.chaves.append(i.rsplit(<span class="string">&quot;/&quot;</span>)[-<span class="number">2</span>])</span><br><span class="line">    logger.info(repositories.chaves)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    repositories()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    <span class="string">&quot;Here we do the update&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> repositories.chaves:</span><br><span class="line">        cmd = <span class="string">&quot;/home/mic/scripts/git_manager/&quot;</span> + i + <span class="string">&quot;.exp&quot;</span></span><br><span class="line">        subprocess.run(cmd, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    update()</span><br></pre></td></tr></table></figure>
</div></div><div class="footer"><div class="footer-copyright">Theme By <a target="_blank" rel="noopener" href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>