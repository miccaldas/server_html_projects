<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>new-micro-blog</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/heti.min.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
</head><body><div class="header"><a class="github-link" target="_blank" rel="noopener" href="https://notabug.org/micaldas"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="email-link" href="mailto:mclds@protonmail.com"><img class="email-image" src="/images/email-small.png"></a><a class="subscribe-link" href="/atom.xml"><img class="subscribe-image" src="/images/subscribe-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">new-micro-blog</p></h2><div class="post-date"><time datetime="2021-08-22T15:40:33.000Z">2021-08-22</time></div><div class="post-content"><p>I just remade the micro_blog app. Although I liked the way it looked and how it worked, I was extremely aware that the app was running on Urwid, that grand Dame of coding, all wit, charm and Alzheimer, and if I liked it, that had more to do to a rare and happy moment of serendipity, and not anything that we could ever hope to repeat and redo.<br>The inspiration came in a roundabout way. I was trying to wrap my head around <a target="_blank" rel="noopener" href="https://www.sqlalchemy.org/">SQLAlchemy</a>, and why it was so bloody hard to understand, and why, Oh my God, why?!, the documentation was so breathlessly obscurantist. Honestly, in my opinion, it’s much, much simpler to try to understand SQL commands, than it is to venture to the esoteric realms of the ORMs.<br>I, personally always liked to learn SQL, it’s a fun language and it is used in a very cool area, databases. Can’t fathom why someone would sacrifice so much to avoid it.<br>As it was expected, I couldn’t make heads or tails of SQLAlchemy, so I started looking at other, simpler, ORMs, where I could have an introduction that wasn’t as violent. I finally ended up in <a target="_blank" rel="noopener" href="http://docs.peewee-orm.com/">Peewee</a>, who has sane sounding documentation, and an apparent willingness to complicate things only if strictly necessary. Even so, I had some difficulty entering in the logic of these software. My breakthrough occurred when I gave up on their documentation and started building the project examples they have on their site. They’re all cool ideas, and I felt inspired to do them all.<br>The first one I did ended up substituting the old micro_blog app by a new one. So it’s engaging stuff.<br>The project proposed entailed creating a diary cli app that would have a encrypted database backend. Which I thought was pretty cool. This immediately reminded me of the micro_blog project, as I intended it to be a strongly confessional experience. It ended up being me absent mindedly writing some of the most inane and milquetoast observations ever heard outside a political parliament.<br>Not that I have given up on it. No. I still think the idea has value. It is just that I haven’t been on the right mindset for fearless self-examination for quite some time.<br>The project proved out to be as entertaining as its concept. The solutions presented are interesting and they were all in a comfortable level of difficulty. Not very overly hard, but with enough intelligence and creativity to be interesting.<br>And here’s what I did:  </p>
<ol>
<li>The module starts with the declaring of a SQLite variable as our database. It’s been a while since I used SQLite databases. That was fun too. Then, as is customary on this type of software, It will be instantiated a class, that in its constituent parts, will end up representing all the concepts of a traditional SQL database.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Defines table and its structure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param content: column/attribute, defines a text column in the table</span></span><br><span class="line"><span class="string">    :param timestamp: column/attribute defines timestamp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    content = TextField()</span><br><span class="line">    timestamp = DateTimeField(default=datetime.datetime.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure></li>
<li>After that we define the database connection and its first table.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch  </span><span class="comment"># Decorator for loguru. All errors will go log. Has to be on all functions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Defines db connection and a</span></span><br><span class="line"><span class="string">    db table.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param db: init: application, defines connection</span></span><br><span class="line"><span class="string">        Entry.create_table, command, creates a db table</span></span><br><span class="line"><span class="string">    :param passphrase: str, password</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pwd = <span class="built_in">str</span>(os.environ[<span class="string">&quot;MICRO_PWD&quot;</span>])</span><br><span class="line">    db.init(<span class="string">&quot;micro_blog.db&quot;</span>, passphrase=pwd)</span><br><span class="line">    Entry.create_table()</span><br></pre></td></tr></table></figure></li>
<li>In this function we define the app’s work loop as well as present to the user, the functionalities that the app has to offer.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu_loop</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Sets the loop where the all application will run.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param choice: Last choice of functionality to use,</span></span><br><span class="line"><span class="string">                   from the apps alternatives.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">            prints functionality menu</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    choice = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> choice != <span class="string">&quot;q&quot;</span>:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> menu.items():</span><br><span class="line">            <span class="built_in">print</span>(color(<span class="string">&quot;%s) %s&quot;</span> % (key, value.__doc__), fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        choice = <span class="built_in">input</span>(color(<span class="string">&quot;Actions: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)).lower().strip()</span><br><span class="line">        <span class="keyword">if</span> choice <span class="keyword">in</span> menu:</span><br><span class="line">            menu[choice]()</span><br></pre></td></tr></table></figure></li>
<li>Here we define how to add a entry to the app.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_entry</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Add Entry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param &#x27;Enter your entry...&#x27;: str, Asks for new content entry.</span></span><br><span class="line"><span class="string">    :param &#x27;Save entry...&#x27;: str, If yes creates content data and</span></span><br><span class="line"><span class="string">                              and prints &#x27;Saved sucessfully&#x27;</span></span><br><span class="line"><span class="string">    :returns: str</span></span><br><span class="line"><span class="string">    :rtype: &#x27;Saved sucessfully.&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(color(<span class="string">&quot;Enter your entry. Press ctrl+d when finished.&quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">    data = sys.stdin.read().strip()</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">and</span> <span class="built_in">input</span>(color(<span class="string">&quot;Save entry? [Yn] &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)) != <span class="string">&quot;n&quot;</span>:</span><br><span class="line">        Entry.create(content=data)</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;Saved successfully.&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br></pre></td></tr></table></figure></li>
<li>View all entries in the app:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_entries</span>(<span class="params">search_query=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;View previous entries</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param query: variable, Selects all content entries by descending order of</span></span><br><span class="line"><span class="string">         timestamp.</span></span><br><span class="line"><span class="string">    :param search_query: variable, If it originates in the search function,</span></span><br><span class="line"><span class="string">         redirect it to here. (Default value = None)</span></span><br><span class="line"><span class="string">    :returns: Timestamp, entries content and options to manage said content.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    query = Entry.select().order_by(Entry.timestamp.desc())</span><br><span class="line">    <span class="keyword">if</span> search_query:</span><br><span class="line">        query = query.where(Entry.content.contains(search_query))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> entry <span class="keyword">in</span> query:</span><br><span class="line">        timestamp = entry.timestamp.strftime(<span class="string">&quot;%A %B %d, %Y %I:%M%p&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(color(timestamp, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;=&quot;</span> * <span class="built_in">len</span>(timestamp), fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(entry.content, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;n) next entry&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;d) delete entry&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;q) return to main menu&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">input</span>(color(<span class="string">&quot;Choice? (Nq) &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>)) == <span class="string">&quot;q&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li>
<li>Search for entries. That in this case, piggybacks on the view entries function.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_entries</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Search entries</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :returns: Question regarding what is the keyword to use in</span></span><br><span class="line"><span class="string">             their search?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    view_entries(<span class="built_in">input</span>(color(<span class="string">&quot;Search query: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)))</span><br></pre></td></tr></table></figure></li>
<li>This function defines the deletion of content entries.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_entry</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Deletes entry in database</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param del_id: variable, ID value of the entry to delete</span></span><br><span class="line"><span class="string">    :param del_row: variable, The row to be deleted</span></span><br><span class="line"><span class="string">    :param del_row.execute: command, Order to erase entry.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    del_id = <span class="built_in">input</span>(color(<span class="string">&quot;What is the ID of the entry you want to delete? &quot;</span>))</span><br><span class="line">    del_row = Entry.delete().where(Entry.<span class="built_in">id</span> == del_id)</span><br><span class="line">    del_row.execute()</span><br></pre></td></tr></table></figure></li>
<li>And this one, the updating of the entries.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_query</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Updates a value in a row</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param updt_content: str, New content</span></span><br><span class="line"><span class="string">    :param updt_val: command, Update command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    updt_id = <span class="built_in">input</span>(color(<span class="string">&quot;What is the id of your update? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    Entry.updt_column = <span class="built_in">input</span>(color(<span class="string">&quot;What column do you want to update? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    updt_content = <span class="built_in">input</span>(color(<span class="string">&quot;What is it you want to change? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    updt_val = Entry.update(&#123;Entry.updt_column: updt_content&#125;).where(Entry.<span class="built_in">id</span> == updt_id)</span><br><span class="line">    updt_val.execute()</span><br></pre></td></tr></table></figure></li>
<li>This is the menu that app loop keeps serving.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">menu = OrderedDict(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&quot;a&quot;</span>, add_entry),</span><br><span class="line">        (<span class="string">&quot;v&quot;</span>, view_entries),</span><br><span class="line">        (<span class="string">&quot;s&quot;</span>, search_entries),</span><br><span class="line">        (<span class="string">&quot;d&quot;</span>, delete_entry),</span><br><span class="line">        (<span class="string">&quot;u&quot;</span>, update_query),</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li>Finally it’s defined what to do when a user tries to login to the db.<br>In it’s first incarnation, the database was a impregnable fortress, ready to withstand any attack. An example of prudent common sense and sound security precautions. Unfortunately it also made entering in the app a drag. To cut a long story short, I sabotaged all the security measures, just so that I wouldn’t have to sign in every time I went to app.<br>I am not a wise man.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Collect the passphrase using a secure method.</span></span><br><span class="line">    pwd = <span class="built_in">str</span>(os.environ[<span class="string">&quot;MICRO_PWD&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> pwd <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        passphrase = getpass(color(<span class="string">&quot;Enter password: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> passphrase != pwd:</span><br><span class="line">            sys.stderr.write(<span class="string">&quot;Passphrase required to access diary.\n&quot;</span>)</span><br><span class="line">            sys.stderr.flush()</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize the database.</span></span><br><span class="line">    initialize()</span><br><span class="line">    menu_loop()</span><br></pre></td></tr></table></figure></li>
</ol>
<p>The full code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Encrypted version of the Micro Blog. Now done with Peewee ORM&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> getpass <span class="keyword">import</span> getpass</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> playhouse.sqlcipher_ext <span class="keyword">import</span> SqlCipherDatabase</span><br><span class="line"><span class="keyword">from</span> colr <span class="keyword">import</span> color</span><br><span class="line"></span><br><span class="line">fmt = <span class="string">&quot;&#123;time&#125; - &#123;name&#125; - &#123;level&#125; - &#123;message&#125;&quot;</span></span><br><span class="line">logger.add(<span class="string">&quot;info.log&quot;</span>, level=<span class="string">&quot;INFO&quot;</span>, <span class="built_in">format</span>=fmt, backtrace=<span class="literal">True</span>, diagnose=<span class="literal">True</span>)</span><br><span class="line">logger.add(<span class="string">&quot;error.log&quot;</span>, level=<span class="string">&quot;ERROR&quot;</span>, <span class="built_in">format</span>=fmt, backtrace=<span class="literal">True</span>, diagnose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Defer initialization of the database until the script is executed from the</span></span><br><span class="line"><span class="comment"># command-line.</span></span><br><span class="line">db = SqlCipherDatabase(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Defines table and its structure</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param content: column/attribute, defines a text column in the table</span></span><br><span class="line"><span class="string">    :param timestamp: column/attribute defines timestamp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    content = TextField()</span><br><span class="line">    timestamp = DateTimeField(default=datetime.datetime.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch  </span><span class="comment"># Decorator for loguru. All errors will go log. Has to be on all functions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Defines db connection and a</span></span><br><span class="line"><span class="string">    db table.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param db: init: application, defines connection</span></span><br><span class="line"><span class="string">        Entry.create_table, command, creates a db table</span></span><br><span class="line"><span class="string">    :param passphrase: str, password</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pwd = <span class="built_in">str</span>(os.environ[<span class="string">&quot;MICRO_PWD&quot;</span>])</span><br><span class="line">    db.init(<span class="string">&quot;micro_blog.db&quot;</span>, passphrase=pwd)</span><br><span class="line">    Entry.create_table()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu_loop</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Sets the loop where the all application will run.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param choice: Last choice of functionality to use,</span></span><br><span class="line"><span class="string">                   from the apps alternatives.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">            prints functionality menu</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    choice = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> choice != <span class="string">&quot;q&quot;</span>:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> menu.items():</span><br><span class="line">            <span class="built_in">print</span>(color(<span class="string">&quot;%s) %s&quot;</span> % (key, value.__doc__), fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        choice = <span class="built_in">input</span>(color(<span class="string">&quot;Actions: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)).lower().strip()</span><br><span class="line">        <span class="keyword">if</span> choice <span class="keyword">in</span> menu:</span><br><span class="line">            menu[choice]()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_entry</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Add Entry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param &#x27;Enter your entry...&#x27;: str, Asks for new content entry.</span></span><br><span class="line"><span class="string">    :param &#x27;Save entry...&#x27;: str, If yes creates content data and</span></span><br><span class="line"><span class="string">                              and prints &#x27;Saved sucessfully&#x27;</span></span><br><span class="line"><span class="string">    :returns: str</span></span><br><span class="line"><span class="string">    :rtype: &#x27;Saved sucessfully.&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(color(<span class="string">&quot;Enter your entry. Press ctrl+d when finished.&quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">    data = sys.stdin.read().strip()</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">and</span> <span class="built_in">input</span>(color(<span class="string">&quot;Save entry? [Yn] &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)) != <span class="string">&quot;n&quot;</span>:</span><br><span class="line">        Entry.create(content=data)</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;Saved successfully.&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_entries</span>(<span class="params">search_query=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;View previous entries</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param query: variable, Selects all content entries by descending order of</span></span><br><span class="line"><span class="string">         timestamp.</span></span><br><span class="line"><span class="string">    :param search_query: variable, If it originates in the search function,</span></span><br><span class="line"><span class="string">         redirect it to here. (Default value = None)</span></span><br><span class="line"><span class="string">    :returns: Timestamp, entries content and options to manage said content.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    query = Entry.select().order_by(Entry.timestamp.desc())</span><br><span class="line">    <span class="keyword">if</span> search_query:</span><br><span class="line">        query = query.where(Entry.content.contains(search_query))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> entry <span class="keyword">in</span> query:</span><br><span class="line">        timestamp = entry.timestamp.strftime(<span class="string">&quot;%A %B %d, %Y %I:%M%p&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(color(timestamp, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;=&quot;</span> * <span class="built_in">len</span>(timestamp), fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(entry.content, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;n) next entry&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;d) delete entry&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(color(<span class="string">&quot;q) return to main menu&quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">input</span>(color(<span class="string">&quot;Choice? (Nq) &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>)) == <span class="string">&quot;q&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_entries</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Search entries</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :returns: Question regarding what is the keyword to use in</span></span><br><span class="line"><span class="string">             their search?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    view_entries(<span class="built_in">input</span>(color(<span class="string">&quot;Search query: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_entry</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Deletes entry in database</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param del_id: variable, ID value of the entry to delete</span></span><br><span class="line"><span class="string">    :param del_row: variable, The row to be deleted</span></span><br><span class="line"><span class="string">    :param del_row.execute: command, Order to erase entry.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    del_id = <span class="built_in">input</span>(color(<span class="string">&quot;What is the ID of the entry you want to delete? &quot;</span>))</span><br><span class="line">    del_row = Entry.delete().where(Entry.<span class="built_in">id</span> == del_id)</span><br><span class="line">    del_row.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_query</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Updates a value in a row</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param updt_content: str, New content</span></span><br><span class="line"><span class="string">    :param updt_val: command, Update command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    updt_id = <span class="built_in">input</span>(color(<span class="string">&quot;What is the id of your update? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    Entry.updt_column = <span class="built_in">input</span>(color(<span class="string">&quot;What column do you want to update? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    updt_content = <span class="built_in">input</span>(color(<span class="string">&quot;What is it you want to change? &quot;</span>, fore=<span class="string">&quot;#a4bdba&quot;</span>))</span><br><span class="line">    updt_val = Entry.update(&#123;Entry.updt_column: updt_content&#125;).where(Entry.<span class="built_in">id</span> == updt_id)</span><br><span class="line">    updt_val.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">menu = OrderedDict(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&quot;a&quot;</span>, add_entry),</span><br><span class="line">        (<span class="string">&quot;v&quot;</span>, view_entries),</span><br><span class="line">        (<span class="string">&quot;s&quot;</span>, search_entries),</span><br><span class="line">        (<span class="string">&quot;d&quot;</span>, delete_entry),</span><br><span class="line">        (<span class="string">&quot;u&quot;</span>, update_query),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Collect the passphrase using a secure method.</span></span><br><span class="line">    pwd = <span class="built_in">str</span>(os.environ[<span class="string">&quot;MICRO_PWD&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> pwd <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        passphrase = getpass(color(<span class="string">&quot;Enter password: &quot;</span>, fore=<span class="string">&quot;#c3bcb1&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span> passphrase != pwd:</span><br><span class="line">            sys.stderr.write(<span class="string">&quot;Passphrase required to access diary.\n&quot;</span>)</span><br><span class="line">            sys.stderr.flush()</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize the database.</span></span><br><span class="line">    initialize()</span><br><span class="line">    menu_loop()</span><br></pre></td></tr></table></figure>
</div></div><div class="footer"><div class="footer-copyright">Theme By <a target="_blank" rel="noopener" href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>