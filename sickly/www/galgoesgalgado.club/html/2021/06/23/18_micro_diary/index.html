<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Micro Diary</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/heti.min.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
</head><body><div class="header"><a class="github-link" target="_blank" rel="noopener" href="https://notabug.org/micaldas"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="email-link" href="mailto:mclds@protonmail.com"><img class="email-image" src="/images/email-small.png"></a><a class="subscribe-link" href="/atom.xml"><img class="subscribe-image" src="/images/subscribe-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">Micro Diary</p></h2><div class="post-date"><time datetime="2021-06-23T07:06:00.000Z">2021-06-23</time></div><div class="post-content"><p>I had this idea that it would be nice to have a space where I could keep, as you keep code snippets, idea snippets.<br>Small observations, asides to myself, all the small minutiae that ends up having more heft that we anticipate.<br>My idea is to create a cli environment that is inviting to write and read, and also to put it online to be, also, accessed mainly by terminal.<br>At the moment I have the writing part done, same procedure as always, write to database, access it from there, and have a facsimile of of navigation through the content.<br>I call it a facsimile only because I have no shame, itâ€™s not even that. At the moment is a no-simile. But the truth is I can scroll through the entries doing ctrl-q, for reasons thatâ€™ll be clearer in a moment. So, I am happy for now.<br>I wanted something very simple, just a short text and a date. Nothing more.<br>The problem is the concept of page in a terminal.<br>Not that it has not been done. It has, for ages. Just not by me or with tools I can understand.<br>One of my greatest, and saddest failures, was my inability to understand the <a target="_blank" rel="noopener" href="https://docs.python.org/3/howto/curses.html">curses</a> library.<br>I could never get my head around it, no matter how many tutorials I read.<br>But, buttressed in the knowledge that that was then, and this is now, a present where Iâ€™m more python worldly, we hope, I tried again.<br>Strangely, to some success.<br>Not with curses mind you, that is still a dark continent for me; but with <a target="_blank" rel="noopener" href="http://urwid.org/">urwid</a>, a library as old as time itself that, on this occasion, shared a small part of its secrets with me. Just as with curses, I already knew urwid. I spent many unhappy hours trying to decipher itâ€™s arcane code.<br>Now that I know a bit more, I still find it very difficult to follow.<br>Itâ€™s very class based, and if that is not your comfort zone, as it isnâ€™t mine, youâ€™ll have a bad time.<br>But thankfully I have recently dabbled a bit in classes, and the subject is fresher in my head than usual. So I understood some of the stuff that was there.<br>This is what I did.</p>
<p>I went to the tutorial in their site and looked for the simplest example I could steal. I found one that was adequately pedestrian and created this module to write a post.<br>First there is a function to create a keybinding to exit the file. It links â€˜qâ€™ or â€˜Qâ€™ to a â€˜ExitMainLoopâ€™ urwid function, that takes you out of the main loop. The main loop is where most of the urwid code is contained. Even if you exit the main loop, the program will execute whatever may be after its completion.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_on_q</span>(<span class="params">key</span>):</span></span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> (<span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>):</span><br><span class="line">        <span class="keyword">raise</span> urwid.ExitMainLoop()</span><br></pre></td></tr></table></figure>
<p>And now the â€˜voodoo codeâ€™ begins. I will tentatively try to explain what is in here; much more as an exercise to clarify my thoughts than any attempt at explaining what is there. I just hope itâ€™s enough for future me.<br>A class is created to house our app, or widget, in urwid parlance. This one inherits from <a target="_blank" rel="noopener" href="http://urwid.org/reference/widget.html?highlight=filler#urwid.Filler">Filler</a>, a class that describes a visual widget that occupies space above and below a given area.<br>Here weâ€™ll use the urwid method of keypress, to shape it to our needs. I think that is more or less the philosophy of this library; get the code and shape it.<br>A function called <a target="_blank" rel="noopener" href="http://urwid.org/reference/widget.html?highlight=keypress#urwid.Filler.keypress">keypress</a> instantiates urwid.Filler.keypress(). We define that, if the key is not â€˜Enterâ€™, it should return the attributes of the parent class, write the text to explain that itâ€™s the â€˜qâ€™ character that gets you out of mischief and align it by the center.<br>If this explanation feels a bit â€˜hand-wavyâ€™, thatâ€™s because it is.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionBox</span>(<span class="params">urwid.Filler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keypress</span>(<span class="params">self, size, key</span>):</span></span><br><span class="line">        <span class="keyword">if</span> key != <span class="string">&#x27;enter&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>(QuestionBox, self).keypress(size, key)</span><br><span class="line">        texto = <span class="string">u&quot;%s.\n\nPress Q to exit.&quot;</span> % edit.edit_text</span><br><span class="line">        self.original_widget = urwid.Text(texto, align=<span class="string">&#x27;center&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Next is defined a colour palette for the display attributes that weâ€™re using. These have a foreground and background values. I copied this three elements from the example, but it could have any other configuration.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">palette = [</span><br><span class="line">    (<span class="string">&#x27;banner&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;#ff6f69&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;streak&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;light red&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;bg&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;#ff6f69&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Now itâ€™s defined a text editing field, <a target="_blank" rel="noopener" href="http://urwid.org/reference/widget.html?highlight=edit#urwid.Edit">urwid.Edit</a>, which acts as a prompt of sorts. We give it a name, so we can color it as a display attribute, put on a unicode glyph for prettiness sake and tell it to align the text in the center.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit = urwid.Edit((<span class="string">&#x27;banner&#x27;</span>, <span class="string">u&quot;ðŸ¡º\n\n&quot;</span>), align=<span class="string">&#x27;center&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>We then create a variable that weâ€™ll embody our Question Box class with text editing field inserted.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fill = QuestionBox(edit)</span><br></pre></td></tr></table></figure>
<p>We define the main loop with classes, color settings and keybinding,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop = urwid.MainLoop(fill, palette, unhandled_input=exit_on_q)</span><br></pre></td></tr></table></figure>
<p>We declare thatâ€™ll will be using 256 colours.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop.screen.set_terminal_properties(colors=<span class="number">256</span>)</span><br></pre></td></tr></table></figure>
<p>The background is defined,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop.widget = urwid.AttrMap(fill, <span class="string">&#x27;bg&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>and the loop is ran.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop.run()</span><br></pre></td></tr></table></figure>
<p>After closing the main loop, we write the user-written post to a file. The reason for this convoluted solution is that I couldnâ€™t get the value in any other way.<br>I discovered, through trial and error, that you canâ€™t put two edit commands in the same loop. As an example, in this case I need to input, per post, not only its text, but also its tags. What would be convenient, would be a solution that looked like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">edit = urwid.Edit(&#x27;POST&#x27;)</span><br><span class="line">edit1 = urwid.Edit(&#x27;TAGS&#x27;)</span><br><span class="line">blah, blah,</span><br><span class="line">loop.definition</span><br><span class="line">loop.run</span><br></pre></td></tr></table></figure>
<p>But this is impossible. The only solution I found. And by that I mean, the only solution that avoided that I looked deeply and seriously to the structure of the library, and instead looked for a solution that gave a result in the least amount of time; was to create two modules, one for each edition moment, and connect it later in the â€˜mainâ€™ file.<br>This has proven harder that expected, as I imported the urwid modules, nothing more was read in the main file.<br>Again, and true to form, I avoided trying to solve this problem by structuring the main file not as main.py but as main.sh. Thusly:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env zsh</span><br><span class="line"></span><br><span class="line">python3 post.py # Where the writing of the post was defined.</span><br><span class="line">python3 tags.py # The same for the tags.</span><br><span class="line">python3 connections.py # This is the next part.</span><br></pre></td></tr></table></figure>
<p>We have now two text files, one with the text of the post, the other with the tags that accompany it.<br>All that there is now to do is to upload it to the db.<br>Which is done this way:  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mysql.connector <span class="keyword">import</span> connect, Error</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connections</span>():</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;post.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    f_tags = <span class="built_in">open</span>(<span class="string">&#x27;tags.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    post_content = f.read()</span><br><span class="line">    tags_content = f_tags.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn = connect(</span><br><span class="line">                host=<span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">                user=<span class="string">&quot;mic&quot;</span>,</span><br><span class="line">                password=<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">                database=<span class="string">&quot;micro_diary&quot;</span>)</span><br><span class="line">        cur = conn.cursor()</span><br><span class="line">        answers = [post_content, tags_content]</span><br><span class="line">        query = <span class="string">&quot;&quot;&quot; INSERT INTO micro_diary (text, tags) VALUES (%s, %s) &quot;&quot;&quot;</span></span><br><span class="line">        cur.execute(query, answers)</span><br><span class="line">        conn.commit()</span><br><span class="line">    <span class="keyword">except</span> Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error while connecting to db&quot;</span>, e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span>(conn):</span><br><span class="line">            conn.close()</span><br><span class="line"></span><br><span class="line">    f.close()</span><br><span class="line">    f_tags.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    connections()</span><br></pre></td></tr></table></figure>
<p>To see the content, I created the following module that, by the fact that I showed a lot of others like it, I wonâ€™t loose much time explaining it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mysql.connector <span class="keyword">import</span> connect, Error</span><br><span class="line"><span class="keyword">import</span> urwid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_on_q</span>(<span class="params">key</span>):</span></span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> (<span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>):</span><br><span class="line">        <span class="keyword">raise</span> urwid.ExitMainLoop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span>():</span></span><br><span class="line"></span><br><span class="line">    palette = [</span><br><span class="line">        (<span class="string">&#x27;banner&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;#ff6f69&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;streak&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;light red&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;bg&#x27;</span>, <span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;#ff6f69&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn = connect(</span><br><span class="line">                host=<span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">                user=<span class="string">&quot;mic&quot;</span>,</span><br><span class="line">                password=<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">                database=<span class="string">&quot;micro_diary&quot;</span>)</span><br><span class="line">        cur = conn.cursor()</span><br><span class="line">        query = <span class="string">&quot;SELECT * FROM micro_diary&quot;</span></span><br><span class="line">        cur.execute(query,)</span><br><span class="line">        records = cur.fetchall()</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> records:</span><br><span class="line">            txt = urwid.Text((<span class="string">&#x27;banner&#x27;</span>, <span class="string">&#x27;%s\n\n%s&#x27;</span> % (row[<span class="number">1</span>], row[<span class="number">2</span>])), align=<span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">            fill = urwid.Filler(txt)</span><br><span class="line">            loop = urwid.MainLoop(fill, palette, unhandled_input=exit_on_q)</span><br><span class="line">            loop.screen.set_terminal_properties(colors=<span class="number">256</span>)</span><br><span class="line">            loop.widget = urwid.AttrMap(fill, <span class="string">&#x27;bg&#x27;</span>)</span><br><span class="line">            loop.run()</span><br><span class="line">    <span class="keyword">except</span> Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error while connecting to db&quot;</span>, e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span>(conn):</span><br><span class="line">            conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    see()</span><br></pre></td></tr></table></figure>
</div></div><div class="footer"><div class="footer-copyright">Theme By <a target="_blank" rel="noopener" href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>