<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>more tales about RSS</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/heti.min.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
</head><body><div class="header"><a class="github-link" target="_blank" rel="noopener" href="https://notabug.org/micaldas"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="email-link" href="mailto:mclds@protonmail.com"><img class="email-image" src="/images/email-small.png"></a><a class="subscribe-link" href="/atom.xml"><img class="subscribe-image" src="/images/subscribe-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">more tales about RSS</p></h2><div class="post-date"><time datetime="2021-06-23T07:34:12.000Z">2021-06-23</time></div><div class="post-content"><p>I just realized I didn’t finish my post on the RSS feed app.<br>It was my intention to document and comment all the RSS app’s modules in a blog post.<br>So the code doesn’t end up looking as if it was found in a museum with a tag saying: “Unknown Origin. Age: Undetermined. Usage: Some sort of chamber pot, or possibly a drinking vessel. Maybe both.”<br>I meant to do it, but then I changed my approach to the blog, and this was tossed into the “to do when you’re not thinking about anything.”, pile.<br>As I currently am, very actively, not thinking in anything, this must be an auspicious moment to resume this endeavor.  </p>
<hr>
<h2><span id="append_rsspy">append_rss.py</span></h2><p>This module is needed because, in insert_db.py, the line <code>fp = feedparser.parse(url)</code>, wouldn’t accept a function object, which is what happens if you import the outcome of this module directly. So, it was necessary to assure that the URL would be formatted as a string. Hence the passage to a text file. This has the added advantage of creating a record of all feeds in use.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append_rss</span>():</span></span><br><span class="line">        new_rss = <span class="built_in">input</span>(click.style(<span class="string">&#x27; What is the url you want to add? &#x27;</span>, fg=<span class="string">&#x27;magenta&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line">        envio = <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        envio.write(new_rss)</span><br><span class="line">        envio.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    append_rss()</span><br></pre></td></tr></table></figure>
<hr>
<h2><span id="delete_rsspy">delete_rss.py</span></h2><p>Since a text file was created in the last module with a list of the URLs of the<br>feeds in use by the app, it stands to reason that, if wanted, we would edit this<br>file to delete a feed. - We first show the user the available feeds in file ‘lista’:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_rss</span>():</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lista = f.read()</span><br><span class="line">        <span class="built_in">print</span>(lista)</span><br></pre></td></tr></table></figure>
<p>Then we create another function to house the deletion command.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_rss</span>():</span></span><br></pre></td></tr></table></figure>
<p>You need to open the file and read its contents in memory, then open the file again write the<br>line to it but without the line you wish to omit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delete_rss = <span class="built_in">input</span>(click.style(<span class="string">&#x27; What is the url you want to delete? &#x27;</span>, fg=<span class="string">&#x27;magenta&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> line.strip(<span class="string">&#x27;\n&#x27;</span>) != delete_rss:</span><br><span class="line">            f.write(line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    delete_rss()</span><br></pre></td></tr></table></figure>
<hr>
<h2><span id="insert_dbpy">insert_db.py</span></h2><p>In order to keep our database clean and up to date we’ll first delete old entries in the database,<br>and create new ones. - From <a target="_blank" rel="noopener" href="https://dateutil.readthedocs.io/en/stable/index.html">Dateutil</a>, a library for date manipulations, we’ll import parse. We also need SQLite for db access and <a target="_blank" rel="noopener" href="https://pythonhosted.org/feedparser/#">Feedparser</a> for the RSS.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> feedparser</span><br></pre></td></tr></table></figure>
<p>Open a SQLite connector and erase all entries in the table,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_old</span>():</span></span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(<span class="string">&#x27;rss.db&#x27;</span>) <span class="keyword">as</span> db:</span><br><span class="line">        cur = db.cursor()</span><br><span class="line">        inserir = <span class="string">&#x27;DELETE FROM rss;&#x27;</span></span><br><span class="line">        cur.execute(inserir,),</span><br><span class="line">        db.commit()</span><br></pre></td></tr></table></figure>
<p>Define a function containing the URL of the RSS.<br>Define what elements of the feed we are going to use. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rss</span>():</span></span><br></pre></td></tr></table></figure>
<p>Read the file into a list of lines,<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	urls = f.read().splitlines()</span><br></pre></td></tr></table></figure><br>define 0 as the start of our index,<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span></span><br></pre></td></tr></table></figure><br>connect to the db,<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;url_list.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	urls = f.read().splitlines()</span><br></pre></td></tr></table></figure><br>create feedparser object for each publication in the file list,<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">	fp = feedparser.parse(url)</span><br><span class="line">	nome = fp[<span class="string">&#x27;feed&#x27;</span>][<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">	<span class="built_in">print</span>(nome)</span><br></pre></td></tr></table></figure><br>for each unique number that defines each content piece, we take out the ones that have a item named ‘title’ and ‘link’ and turn them to strings. As not all publications had the ‘published’ item, it was necessary to place its extraction inside a ‘try/except’ element, or the module would stop with key and attribute errors. Also, as it is a time element, the date format imported by the feed is not valid in SQLite3. So it was necessary to change it to something more acceptable.<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(fp.entries)):</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		titulo = fp.entries[index].title</span><br><span class="line">		titulo = <span class="built_in">str</span>(titulo)</span><br><span class="line">		linque = fp.entries[index].link</span><br><span class="line">		linque = <span class="built_in">str</span>(linque)</span><br><span class="line">		publi = fp.entries[index].published</span><br><span class="line">		publi = <span class="built_in">str</span>(publi)</span><br><span class="line">		pub = parse(publi)</span><br><span class="line">		tempo = pub.strftime(<span class="string">&#x27;%y/%m/%d&#x27;</span>)</span><br><span class="line">	                    <span class="keyword">except</span> KeyError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">except</span> AttributeError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        fp.entries[index].pubDate</span><br><span class="line">                        publi = fp.entries[index].pubDate</span><br><span class="line">                        publi = <span class="built_in">str</span>(publi)</span><br><span class="line">                        pub = parse(publi)</span><br><span class="line">                        tempo = pub.strftime(<span class="string">&#x27;%y/%m/%d&#x27;</span>)</span><br><span class="line">                    <span class="keyword">except</span> KeyError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">except</span> AttributeError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                <span class="keyword">except</span> AttributeError:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        fp.entries[index].updated</span><br><span class="line">                        publi = fp.entries[index].updated</span><br><span class="line">                        publi = <span class="built_in">str</span>(publi)</span><br><span class="line">                        pub = parse(publi)</span><br><span class="line">                        tempo = pub.strftime(<span class="string">&#x27;%y/%m/%d&#x27;</span>)</span><br><span class="line">                    <span class="keyword">except</span> KeyError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">except</span> AttributeError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="comment"># 6</span></span><br><span class="line">                        fp.entries[index].pubDate</span><br><span class="line">                        publi = fp.entries[index].pubDate</span><br><span class="line">                        publi = <span class="built_in">str</span>(publi)</span><br><span class="line">                        pub = parse(publi)</span><br><span class="line">                        tempo = pub.strftime(<span class="string">&#x27;%y/%m/%d&#x27;</span>)</span><br><span class="line">                    <span class="keyword">except</span> KeyError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">except</span> AttributeError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                inserir = <span class="string">&#x27;INSERT INTO rss (name, title, link, date) VALUES (?, ?, ? , ?)&#x27;</span></span><br><span class="line">                cur.execute(inserir, (nome, titulo, linque, tempo)),</span><br><span class="line">                db.commit()</span><br></pre></td></tr></table></figure></p>
<hr>
<h2><span id="show_rsspy">show_rss.py</span></h2><p>This module shows the content of the db.<br>Turned it to a module, so I can separate changing the db and seeing it.<br>In essence, you just open the db and embellish the output.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> sqlite3.connect(<span class="string">&#x27;rss.db&#x27;</span>) <span class="keyword">as</span> db:</span><br><span class="line">        cur = db.cursor()</span><br><span class="line">        cur.execute(<span class="string">&#x27;SELECT * FROM rss ORDER BY strftime(date) ASC&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">        rows = cur.fetchall()</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27;Ж - &#x27;</span>, fg=<span class="string">&#x27;bright_blue&#x27;</span>, bold=<span class="literal">True</span>), click.style(<span class="built_in">str</span>(row[<span class="number">1</span>]), fg=<span class="string">&#x27;bright_blue&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27;Щ - &#x27;</span>, fg=<span class="string">&#x27;bright_cyan&#x27;</span>, bold=<span class="literal">True</span>), click.style(<span class="built_in">str</span>(row[<span class="number">2</span>]), fg=<span class="string">&#x27;bright_cyan&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27;Ÿ - &#x27;</span>, fg=<span class="string">&#x27;bright_blue&#x27;</span>, bold=<span class="literal">True</span>), click.style(<span class="built_in">str</span>(row[<span class="number">3</span>]), fg=<span class="string">&#x27;bright_blue&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27;Ʞ -&#x27;</span>, fg=<span class="string">&#x27;bright_cyan&#x27;</span>, bold=<span class="literal">True</span>), click.style(<span class="built_in">str</span>(row[<span class="number">4</span>]), fg=<span class="string">&#x27;bright_cyan&#x27;</span>, bold=<span class="literal">True</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2><span id="sources_searchpy">sources_search.py</span></h2><p>Internal function that calls the db by publication. Called from the main module.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ith sqlite3.connect(<span class="string">&#x27;rss.db&#x27;</span>) <span class="keyword">as</span> db:</span><br><span class="line">        cur = db.cursor()</span><br><span class="line">        expression = <span class="string">&#x27;SELECT * FROM rss_fts WHERE rss_fts MATCH ? ORDER BY date DESC&#x27;</span></span><br><span class="line">        cur.execute(expression, (source,))</span><br><span class="line">        record = cur.fetchall()</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> record:</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27; 𝝵 &#x27;</span>, fg=<span class="string">&#x27;bright_magenta&#x27;</span>, bold=<span class="literal">True</span>),</span><br><span class="line">                  (click.style(<span class="built_in">str</span>(row[<span class="number">1</span>]), fg=<span class="string">&#x27;bright_magenta&#x27;</span>, bold=<span class="literal">True</span>)))</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27; 𝞇 &#x27;</span>, fg=<span class="string">&#x27;bright_magenta&#x27;</span>, bold=<span class="literal">True</span>),</span><br><span class="line">                  (click.style(<span class="built_in">str</span>(row[<span class="number">2</span>]), fg=<span class="string">&#x27;bright_blue&#x27;</span>, bold=<span class="literal">True</span>)))</span><br><span class="line">            <span class="built_in">print</span>(click.style(<span class="string">&#x27; 𝝮 &#x27;</span>, fg=<span class="string">&#x27;bright_magenta&#x27;</span>, bold=<span class="literal">True</span>),</span><br><span class="line">                  (click.style(<span class="built_in">str</span>(row[<span class="number">3</span>]), fg=<span class="string">&#x27;bright_white&#x27;</span>, bold=<span class="literal">True</span>)))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>


</div></div><div class="footer"><div class="footer-copyright">Theme By <a target="_blank" rel="noopener" href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>